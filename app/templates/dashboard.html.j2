{% extends "base.html.j2" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">üîê Coffre-fort</h1>
    <button onclick="openModal()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-md">
      ‚ûï Ajouter
    </button>
  </div>

  <input type="text" id="search" placeholder="Rechercher un mot de passe..." 
         class="w-full p-3 mb-4 border rounded-md shadow" />

  <div id="password-list">
  {% for entry in passwords %}
    <div class="bg-white rounded-xl shadow p-4 mb-4 flex justify-between items-center">
      <div>
        <h2 class="text-xl font-semibold">{{ entry.title }}</h2>
        <p class="text-sm text-gray-600">Utilisateur : {{ entry.username or "Non d√©fini" }}</p>
        <p class="text-sm text-gray-600">Email : {{ entry.email or "Non d√©fini" }}</p>
      </div>
      <div class="flex items-center space-x-3">
        <span class="text-sm font-medium">
            Criticit√© :
            {% if entry.criticity == 0 %}
              Tr√®s faible
            {% elif entry.criticity == 1 %}
              Faible
            {% elif entry.criticity == 2 %}
              Moyen
            {% elif entry.criticity == 3 %}
              Fort
            {% elif entry.criticity == 4 %}
              Tr√®s fort
            {% endif %}
          </span>
        <button onclick="copyToClipboard('pass-{{ loop.index }}')"
                class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-md">
          Copier
        </button>

        {% if entry.url %}
          <a href="{{ entry.url }}" target="_blank"
             class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-md">
            Aller √† l'URL
          </a>
        {% endif %}

        <!-- Boutons Modifier et Supprimer -->
        <button onclick="editPassword({{ entry.id }}, '{{ entry.title }}', '{{ entry.url }}', '{{ entry.username }}', '{{ entry.email }}', '{{ entry.password }}')"
                class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-md">
          Modifier
        </button>

        <button onclick="deletePassword({{ entry.id }})"
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md">
          Supprimer
        </button>
      </div>
    </div>
  {% else %}
    <p class="text-gray-500 text-center">Aucun mot de passe trouv√©.</p>
  {% endfor %}
</div>


</div>

<!-- MODAL -->
<div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center z-50">
  <div class="bg-white rounded-lg w-full max-w-md p-6">
    <h2 class="text-xl font-bold mb-4">Ajouter un mot de passe</h2>
    <form method="post" action="/add_password">
      <div class="mb-4">
        <label class="block mb-1 font-medium">Titre</label>
        <input type="text" name="title" required class="w-full border rounded-md p-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Url</label>
        <input type="text" name="url" class="w-full border rounded-md p-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Username</label>
        <input type="text" name="username" class="w-full border rounded-md p-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Email</label>
        <input type="text" name="email" class="w-full border rounded-md p-2" />
      </div>
      <div class="mb-4">
        <label class="block mb-1 font-medium">Mot de passe</label>
        <div class="relative">
          <input type="password" name="password" required class="w-full border rounded-md p-2" id="passwordInput" />
          <button type="button" onclick="togglePassword()" class="absolute top-2 right-2 text-gray-500">
            üëÅÔ∏è
          </button>
        </div>
      </div>

      <div class="flex justify-end space-x-2">
        <button type="button" onclick="closeModal()" class="bg-gray-300 px-4 py-2 rounded-md">
          Annuler
        </button>
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-md">
          Enregistrer
        </button>
      </div>
    </form>
  </div>
</div>


<script>
  const searchInput = document.getElementById('search');
  searchInput.addEventListener('input', function () {
    const filter = searchInput.value.toLowerCase();
    const cards = document.querySelectorAll('#password-list > div');

    cards.forEach(card => {
      const title = card.querySelector('h2').textContent.toLowerCase();
      card.style.display = title.includes(filter) ? "flex" : "none";
    });
  });

  function deletePassword(passwordId) {
  const confirmDelete = confirm("√ätes-vous s√ªr de vouloir supprimer ce mot de passe ?");
  if (confirmDelete) {
    var form = document.createElement("form");
    form.method = "POST";
    form.action = "/delete_password/" + passwordId;

    form.appendChild(methodField);

    // Ajouter le formulaire √† la page et soumettre
    document.body.appendChild(form);
    form.submit();
  }
}

function editPassword(passwordId, title, url, username, email, password) {
  // Pr√©-remplir le formulaire modal avec les anciennes donn√©es
    document.querySelector('[name="title"]').value = title;
    document.querySelector('[name="url"]').value = url;
    document.querySelector('[name="username"]').value = username;
    document.querySelector('[name="email"]').value = email;
    document.querySelector('[name="password"]').value = password;

    // Ouvrir le modal
    openModal();

    // Modifier la route d'envoi du formulaire pour la mise √† jour
    document.querySelector('form').action = `/update_password/${passwordId}`;
}


  // Fonction pour copier le mot de passe
function copyToClipboard(inputId) {
  const input = document.getElementById(inputId);
  input.classList.remove("hidden");
  input.select();
  document.execCommand("copy");
  input.classList.add("hidden");

  setTimeout(() => {
    navigator.clipboard.writeText('');
  }, 15000);
}

// Fonction pour afficher ou masquer le mot de passe dans le tableau
function togglePasswordVisibility(inputId) {
  const input = document.getElementById(inputId);
  const type = input.type === "password" ? "text" : "password";
  input.type = type;
}

// Fonction pour afficher/masquer le mot de passe dans la popup
function togglePassword() {
  const passwordInput = document.getElementById('passwordInput');
  const type = passwordInput.type === "password" ? "text" : "password";
  passwordInput.type = type;
}

  function openModal() {
    document.getElementById('addModal').classList.remove('hidden');
    document.getElementById('addModal').classList.add('flex');
  }

  function closeModal() {
    document.getElementById('addModal').classList.add('hidden');
    document.getElementById('addModal').classList.remove('flex');

    //Clean modal

    document.querySelector('[name="title"]').value = "";
    document.querySelector('[name="url"]').value = "";
    document.querySelector('[name="username"]').value = "";
    document.querySelector('[name="email"]').value = "";
    document.querySelector('[name="password"]').value = "";
  }
</script>
{% endblock %}
